#include "nokia_5110.h"

#include <avr/interrupt.h>
#include <avr/io.h>
#include <avr/pgmspace.h>
#include <stdbool.h>
#include <stdint.h>

static const uint8_t font6_8[][6] PROGMEM = {
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // sp
    {0x00, 0x00, 0x00, 0x2f, 0x00, 0x00}, // !
    {0x00, 0x00, 0x07, 0x00, 0x07, 0x00}, // "
    {0x00, 0x14, 0x7f, 0x14, 0x7f, 0x14}, // #
    {0x00, 0x24, 0x2a, 0x7f, 0x2a, 0x12}, // $
    {0x00, 0x62, 0x64, 0x08, 0x13, 0x23}, // %
    {0x00, 0x36, 0x49, 0x55, 0x22, 0x50}, // &
    {0x00, 0x00, 0x05, 0x03, 0x00, 0x00}, // '
    {0x00, 0x00, 0x1c, 0x22, 0x41, 0x00}, // (
    {0x00, 0x00, 0x41, 0x22, 0x1c, 0x00}, // )
    {0x00, 0x14, 0x08, 0x3E, 0x08, 0x14}, // *
    {0x00, 0x08, 0x08, 0x3E, 0x08, 0x08}, // +
    {0x00, 0x00, 0x00, 0xA0, 0x60, 0x00}, // ,
    {0x00, 0x08, 0x08, 0x08, 0x08, 0x08}, // -
    {0x00, 0x00, 0x60, 0x60, 0x00, 0x00}, // .
    {0x00, 0x20, 0x10, 0x08, 0x04, 0x02}, // /
    {0x00, 0x3E, 0x51, 0x49, 0x45, 0x3E}, // 0
    {0x00, 0x00, 0x42, 0x7F, 0x40, 0x00}, // 1
    {0x00, 0x42, 0x61, 0x51, 0x49, 0x46}, // 2
    {0x00, 0x21, 0x41, 0x45, 0x4B, 0x31}, // 3
    {0x00, 0x18, 0x14, 0x12, 0x7F, 0x10}, // 4
    {0x00, 0x27, 0x45, 0x45, 0x45, 0x39}, // 5
    {0x00, 0x3C, 0x4A, 0x49, 0x49, 0x30}, // 6
    {0x00, 0x01, 0x71, 0x09, 0x05, 0x03}, // 7
    {0x00, 0x36, 0x49, 0x49, 0x49, 0x36}, // 8
    {0x00, 0x06, 0x49, 0x49, 0x29, 0x1E}, // 9
    {0x00, 0x00, 0x36, 0x36, 0x00, 0x00}, // :
    {0x00, 0x00, 0x56, 0x36, 0x00, 0x00}, // ;
    {0x00, 0x08, 0x14, 0x22, 0x41, 0x00}, // <
    {0x00, 0x14, 0x14, 0x14, 0x14, 0x14}, // =
    {0x00, 0x00, 0x41, 0x22, 0x14, 0x08}, // >
    {0x00, 0x02, 0x01, 0x51, 0x09, 0x06}, // ?
    {0x00, 0x32, 0x49, 0x59, 0x51, 0x3E}, // @
    {0x00, 0x7C, 0x12, 0x11, 0x12, 0x7C}, // A
    {0x00, 0x7F, 0x49, 0x49, 0x49, 0x36}, // B
    {0x00, 0x3E, 0x41, 0x41, 0x41, 0x22}, // C
    {0x00, 0x7F, 0x41, 0x41, 0x22, 0x1C}, // D
    {0x00, 0x7F, 0x49, 0x49, 0x49, 0x41}, // E
    {0x00, 0x7F, 0x09, 0x09, 0x09, 0x01}, // F
    {0x00, 0x3E, 0x41, 0x49, 0x49, 0x7A}, // G
    {0x00, 0x7F, 0x08, 0x08, 0x08, 0x7F}, // H
    {0x00, 0x00, 0x41, 0x7F, 0x41, 0x00}, // I
    {0x00, 0x20, 0x40, 0x41, 0x3F, 0x01}, // J
    {0x00, 0x7F, 0x08, 0x14, 0x22, 0x41}, // K
    {0x00, 0x7F, 0x40, 0x40, 0x40, 0x40}, // L
    {0x00, 0x7F, 0x02, 0x0C, 0x02, 0x7F}, // M
    {0x00, 0x7F, 0x04, 0x08, 0x10, 0x7F}, // N
    {0x00, 0x3E, 0x41, 0x41, 0x41, 0x3E}, // O
    {0x00, 0x7F, 0x09, 0x09, 0x09, 0x06}, // P
    {0x00, 0x3E, 0x41, 0x51, 0x21, 0x5E}, // Q
    {0x00, 0x7F, 0x09, 0x19, 0x29, 0x46}, // R
    {0x00, 0x46, 0x49, 0x49, 0x49, 0x31}, // S
    {0x00, 0x01, 0x01, 0x7F, 0x01, 0x01}, // T
    {0x00, 0x3F, 0x40, 0x40, 0x40, 0x3F}, // U
    {0x00, 0x1F, 0x20, 0x40, 0x20, 0x1F}, // V
    {0x00, 0x3F, 0x40, 0x38, 0x40, 0x3F}, // W
    {0x00, 0x63, 0x14, 0x08, 0x14, 0x63}, // X
    {0x00, 0x07, 0x08, 0x70, 0x08, 0x07}, // Y
    {0x00, 0x61, 0x51, 0x49, 0x45, 0x43}, // Z
    {0x00, 0x00, 0x7F, 0x41, 0x41, 0x00}, // [
    {0x00, 0x55, 0x2A, 0x55, 0x2A, 0x55}, // 55
    {0x00, 0x00, 0x41, 0x41, 0x7F, 0x00}, // ]
    {0x00, 0x04, 0x02, 0x01, 0x02, 0x04}, // ^
    {0x00, 0x40, 0x40, 0x40, 0x40, 0x40}, // _
    {0x00, 0x00, 0x01, 0x02, 0x04, 0x00}, // '
    {0x00, 0x20, 0x54, 0x54, 0x54, 0x78}, // a
    {0x00, 0x7F, 0x48, 0x44, 0x44, 0x38}, // b
    {0x00, 0x38, 0x44, 0x44, 0x44, 0x20}, // c
    {0x00, 0x38, 0x44, 0x44, 0x48, 0x7F}, // d
    {0x00, 0x38, 0x54, 0x54, 0x54, 0x18}, // e
    {0x00, 0x08, 0x7E, 0x09, 0x01, 0x02}, // f
    {0x00, 0x18, 0xA4, 0xA4, 0xA4, 0x7C}, // g
    {0x00, 0x7F, 0x08, 0x04, 0x04, 0x78}, // h
    {0x00, 0x00, 0x44, 0x7D, 0x40, 0x00}, // i
    {0x00, 0x40, 0x80, 0x84, 0x7D, 0x00}, // j
    {0x00, 0x7F, 0x10, 0x28, 0x44, 0x00}, // k
    {0x00, 0x00, 0x41, 0x7F, 0x40, 0x00}, // l
    {0x00, 0x7C, 0x04, 0x18, 0x04, 0x78}, // m
    {0x00, 0x7C, 0x08, 0x04, 0x04, 0x78}, // n
    {0x00, 0x38, 0x44, 0x44, 0x44, 0x38}, // o
    {0x00, 0xFC, 0x24, 0x24, 0x24, 0x18}, // p
    {0x00, 0x18, 0x24, 0x24, 0x18, 0xFC}, // q
    {0x00, 0x7C, 0x08, 0x04, 0x04, 0x08}, // r
    {0x00, 0x48, 0x54, 0x54, 0x54, 0x20}, // s
    {0x00, 0x04, 0x3F, 0x44, 0x40, 0x20}, // t
    {0x00, 0x3C, 0x40, 0x40, 0x20, 0x7C}, // u
    {0x00, 0x1C, 0x20, 0x40, 0x20, 0x1C}, // v
    {0x00, 0x3C, 0x40, 0x30, 0x40, 0x3C}, // w
    {0x00, 0x44, 0x28, 0x10, 0x28, 0x44}, // x
    {0x00, 0x1C, 0xA0, 0xA0, 0xA0, 0x7C}, // y
    {0x00, 0x44, 0x64, 0x54, 0x4C, 0x44}, // z
    {0x00, 0x00, 0x06, 0x09, 0x09, 0x06}  // horiz lines
};

// Controller port (meaning) : Display port
// PB7(USCK) : CLK
// PB5(MOSI) : DIN
// PB4(_) : DC (data/command mode)
// PB3(_) : CE (chip enable)
// PB2(_) : RST  (TODO ADD TO CIRCUIT)

#define DDR_SPI  DDRB
#define DDR_CLK  DDB7
#define DDR_MOSI DDB5
#define DDR_DC   DDB4
#define DDR_CE   DDB3
#define DDR_RST  DDB2

#define P_SPI  PORTB
#define P_CLK  PB7
#define P_MOSI PB5
#define P_DC   PB4
#define P_CE   PB3
#define P_RST  PB2

#define RST_HIGH()  (P_SPI |= (1 << P_RST))
#define RST_LOW()   (P_SPI &= ~(1 << P_RST))
#define CE_HIGH()   (P_SPI |= (1 << P_CE))
#define CE_LOW()    (P_SPI &= ~(1 << P_CE))
#define DC_HIGH()   (P_SPI |= (1 << P_DC))
#define DC_LOW()    (P_SPI &= ~(1 << P_DC))
#define MOSI_HIGH() (P_SPI |= (1 << P_MOSI))
#define MOSI_LOW()  (P_SPI &= ~(1 << P_MOSI))
#define CLK_HIGH()  (P_SPI |= (1 << P_CLK))
#define CLK_LOW()   (P_SPI &= ~(1 << P_CLK))

typedef enum {
  DM_COMMAND = 0,
  DM_DATA = 1,
} D_MODE;  // DISPLAY MODE

#define DISPLAY_BANKS 6
#define DISPLAY_WIDTH 84

static void gpio_config(void);
static void spi_config(void);
static void write_byte(D_MODE mode, uint8_t b);

static inline void set_mode(D_MODE m)
{
  if (m == DM_COMMAND)
    DC_LOW();
  else
    DC_HIGH();
}
//////////////////////////////////////////////////////////////

void gpio_config(void)
{
  // everything to output
  DDR_SPI = (1 << DDR_CLK) | (1 << DDR_MOSI) | (1 << DDR_DC) | (1 << DDR_CE) |
            (1 << DDR_RST);
}
//////////////////////////////////////////////////////////////

void spi_config(void)
{
  return;
}
//////////////////////////////////////////////////////////////

void write_byte(D_MODE mode, uint8_t b)
{
  CLK_LOW();
  CE_LOW();
  set_mode(mode);
  for (int8_t i = 0; i < 8; ++i) {
    if (b & 0x80) {
      MOSI_HIGH();
    } else {
      MOSI_LOW();
    }

    CLK_HIGH();
    b <<= 1;
    CLK_LOW();
  }

  CE_HIGH();
  CLK_HIGH();
}
//////////////////////////////////////////////////////////////

void nokia5110_init(void)
{
  /* Configure gpio pins */
  gpio_config();
  /* Configure spi pins */
  spi_config();

  set_mode(DM_COMMAND);
  DC_HIGH();
  MOSI_HIGH();
  CLK_HIGH();
  CE_HIGH();

  /* Reset the LCD to a known state */
  RST_LOW();  // Set LCD reset = 0;
  for (uint8_t i = 0; i != 0xff; i++)
    ;  // wait for a while
  RST_HIGH();

  /* Configure LCD module */
  write_byte(DM_COMMAND, 0x21);  // Extended instruction set selected
  write_byte(DM_COMMAND, 0xc0);  // set default contrast (see set_contrast func)
  write_byte(DM_COMMAND, 0x07);  // Set temperature control (TC2)
  write_byte(DM_COMMAND, 0x14);  // Set Bias for 1/48
  write_byte(DM_COMMAND, 0x20);  // Revert to standard instruction set
  write_byte(DM_COMMAND, 0x0c);  // Set display on in "normal" mode
  nokia5110_clear();
}
//////////////////////////////////////////////////////////////

void nokia5110_clear(void)
{
  uint8_t y, x;
  nokia5110_gotoXY(0, 0);
  for (y = 0; y < DISPLAY_BANKS; y++) {
    for (x = 0; x < DISPLAY_WIDTH; x++) {
      write_byte(DM_DATA, 0x00);
    }
  }
  nokia5110_gotoXY(0, 0);
}
//////////////////////////////////////////////////////////////

void nokia5110_gotoXY(int8_t col, int8_t row)
{
  col *= DISPLAY_BANKS;
  write_byte(DM_COMMAND, 0x40 | (uint8_t)row);
  write_byte(DM_COMMAND, 0x80 | (uint8_t)col);
}
//////////////////////////////////////////////////////////////

void nokia5110_write_char(char c)
{
  c -= 32;
  for (uint8_t line = 0; line < DISPLAY_BANKS; ++line) {
    write_byte(DM_DATA, pgm_read_byte(&font6_8[(uint8_t)c][line]));
  }
}
//////////////////////////////////////////////////////////////

void nokia5110_write_str(const char *s)
{
  while (*s)
    nokia5110_write_char(*s++);
}
//////////////////////////////////////////////////////////////

void nokia5110_write_str_s(const char *s, uint8_t len)
{
  while (*s && len--)
    nokia5110_write_char(*s++);
}
//////////////////////////////////////////////////////////////

void nokia5110_set_contrast(uint8_t contrast)
{
  /*  LCD Extended Commands. */
  write_byte(DM_COMMAND, 0x21);
  /* Set LCD Vop (Contrast). */
  write_byte(DM_COMMAND, 0x80 | contrast);
  /*  LCD Standard Commands, horizontal addressing mode. */
  write_byte(DM_COMMAND, 0x20);
}
//////////////////////////////////////////////////////////////

void nokia5110_set_light(bool on)
{
  (void)on;
}
//////////////////////////////////////////////////////////////

void nokia5110_set_pixel(int16_t x, int16_t y)
{
  uint8_t bank = (uint8_t)(y >> 3);
  uint8_t bit = (uint8_t)(y - (bank << 3));
  uint8_t c = (uint8_t)(1 << bit);
  write_byte(DM_COMMAND, 0x40 | (uint8_t)bank);
  write_byte(DM_COMMAND, 0x80 | (uint8_t)x);
  write_byte(DM_DATA, c);
}
//////////////////////////////////////////////////////////////
